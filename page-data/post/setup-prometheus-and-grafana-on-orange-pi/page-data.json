{"componentChunkName":"component---src-templates-blog-post-js","path":"/post/setup-prometheus-and-grafana-on-orange-pi/","result":{"data":{"site":{"siteMetadata":{"title":"Rajitha's blog"}},"markdownRemark":{"id":"1e1ede0c-1fb4-573b-805f-6664b223c8a8","excerpt":"Hi everyone , Hope yall are doing well,\nif you have been keeping up with my posts you know that I have an orange pi that is sitting down.\nI recently startedâ€¦","html":"<h2>Hi everyone ,</h2>\n<!-- <span style=\"font-size:1.28rem;\"> -->\n<p>Hope yall are doing well,\nif you have been keeping up with my posts you know that I have an orange pi that is sitting down.\nI recently started doing some configuration management and infrastructure as code stuff with ansible and terraform.</p>\n<br>\n<p>So I decided to spin Prometheus and grafana to monitor orange pi. I didn't use Ansible for setting up this in orange pi, because I didn't have any idea whether it was supported or not in that arm7 platform but it turned out to be working really well. so in this post, I will walk through my journey on setting orange pi monitoring with Prometheus and grafana.</p>\n<p>so I get started with updating the orange pi.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update</code></pre></div>\n<p>I first installed downloaded the Prometheus from their <a href=\"https://github.com/prometheus/prometheus/releases/tag/v2.28.1\">github</a> release. because my orangepi is base on arm7 architecture I downloaded the respective archive. here <code class=\"language-text\">-OL</code> in the curl will redirect if need and save the output file.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-OL</span> https://github.com/prometheus/prometheus/releases/download/v2.28.1/prometheus-2.28.1.linux-armv7.tar.gz</code></pre></div>\n<p>after downloading the image extract it to a folder.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xzvf</span> prometheus-2.29.0-rc.0.linux-armv7.tar.gz prometheus-2.29.0-rc.0.linux-armv7/\n</code></pre></div>\n<p>next, I copied the Prometheus binary to the <code class=\"language-text\">/usr/local/bin/</code> because that I generally where your binary files live in.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> prometheus-2.29.0-rc.0.linux-armv7/\n<span class=\"token function\">cp</span> prometheus /usr/local/bin/</code></pre></div>\n<p>after all that was set up, I created a service file for <code class=\"language-text\">systemd</code> to configure Prometheus as a service in <code class=\"language-text\">/etc/systemd/system/</code>.\nthis directory is where we write <code class=\"language-text\">systemd</code> unit files. there are many places among this one but this I a conventional directory that is best suited in this scenario.</p>\n<p><code class=\"language-text\">sudo nano /etc/systemd/system/prometheus.service</code></p>\n<div class=\"gatsby-highlight\" data-language=\"unit\"><pre class=\"language-unit\"><code class=\"language-unit\">[Unit]\nDescription=Prometheus monitoring\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=simple\nExecStart=/usr/local/bin/prometheus \\\n                    --config.file /home/batman/prometheus/prometheus.yml \\\n                    --web.route-prefix=/ \\\n                    --web.external-url=http://rizky.lab/prometheus\nRestart=always\n\n[Install]\nWantedBy=multi-user.target</code></pre></div>\n<p>in this file, I have added the <code class=\"language-text\">ExecStart</code> path to the Prometheus binary. here I also added some more arguments to configure Prometheus, because I want to run Prometheus behind an Nginx reverse proxy. and also added the config file in path <code class=\"language-text\">/home/batman/prometheus/prometheus.yml</code> so make sure you have the default <code class=\"language-text\">prometheus.yml</code> (comes with the <code class=\"language-text\">tar</code> archive) file in the specified path.</p>\n<p>after that is done. I restarted the <code class=\"language-text\">systemd</code> <code class=\"language-text\">daemon</code> and then enable the service.\nenabling service will make sure that this service will run after a reboot. it might do many other things behind the back but I notice this when I used this service without enabling it.\nnext stared Prometheus.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl daemon-reload\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> prometheus\n<span class=\"token function\">sudo</span> systemctl restart prometheus\n<span class=\"token function\">sudo</span> systemctl status prometheus\n</code></pre></div>\n<p>next, we can start installing the <a href=\"https://github.com/prometheus/node_exporter/releases/tag/v1.2.0\">node_exporter</a> for orange pi\nhere also, I looked the same way, searched for the <code class=\"language-text\">armv7</code> architecture binary.\njust as before download extract and copy it to the <code class=\"language-text\">/usr/local/bin/</code> directory.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-OL</span> https://github.com/prometheus/node_exporter/releases/download/v1.2.0/node_exporter-1.2.0.linux-armv7.tar.gz\n<span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xzvf</span> node_exporter-1.2.0.linux-armv7.tar.gz node_exporter-1.2.0.linux-armv7/\n<span class=\"token builtin class-name\">cd</span> node_exporter-1.2.0.linux-armv7/\n<span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> node_exporter  /usr/local/bin/\n</code></pre></div>\n<p>next, I repeated the same steps for creating the unit file for <code class=\"language-text\">systemd</code>.</p>\n<p><code class=\"language-text\">sudo nano /etc/systemd/system/nodeexporter.service</code></p>\n<div class=\"gatsby-highlight\" data-language=\"unit\"><pre class=\"language-unit\"><code class=\"language-unit\">[Unit]\nDescription=node exporter for node monitoring\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=simple\nExecStart=/usr/local/bin/node_exporter\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n</code></pre></div>\n<p>after setting up the node_exporter , reload <code class=\"language-text\">systemd</code> <code class=\"language-text\">daemon</code> and restarted node_exporter.\nkeep in mind the service will name after the name of the service file. here node_exporter service will be recognized as nodeexporter because I named the unit file <code class=\"language-text\">nodeexporter.service</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl daemon-reload\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> nodeexporter\n<span class=\"token function\">sudo</span> systemctl restart nodeexporter\n<span class=\"token function\">sudo</span> systemctl status nodeexporter\n</code></pre></div>\n<p>now that we have all in place, next add this nodeexporter to Prometheus as a target. to do that we need to edit the\n<code class=\"language-text\">prometheus.yml</code> file we specified earlier. I appended the following to the <code class=\"language-text\">prometheus.yml</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"node_exporter\"</span>\n\n  <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"localhost:9100\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>after that restart, Prometheus to catch up with new changes. you can see the change at this point if you visit Prometheus via its opened port.</p>\n<p>after that, I set up <a href=\"https://grafana.com/\">Grafana</a> for the monitoring dashboard.</p>\n<p>For Grafana, it's a bit different than the last approach, hence it could be installed with apt.\nI pretty much followed they're <a href=\"https://grafana.com/docs/grafana/latest/installation/debian/\">offcial documentation</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> <span class=\"token parameter variable\">-q</span> <span class=\"token parameter variable\">-O</span> - https://packages.grafana.com/gpg.key <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> apt-key <span class=\"token function\">add</span> -\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deb https://packages.grafana.com/oss/deb stable main\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> <span class=\"token parameter variable\">-a</span> /etc/apt/sources.list.d/grafana.list\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> grafana\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> systemctl demon-reload\n<span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> grafana-server\n<span class=\"token function\">sudo</span> systemctl start grafana-server\nsystemctl status grafana-server\n</code></pre></div>\n<p>hereafter setting up everything I need to alter come configurations in the <code class=\"language-text\">grafana.ini</code> file to allow Grafana to access behind a reverse proxy.\nthis Grafana file lives in <code class=\"language-text\">/etc/grafana</code> directory by default.</p>\n<p>in that configuration we have to set <code class=\"language-text\">domain</code> , <code class=\"language-text\">root_url</code> and <code class=\"language-text\">serve_from_sub_path</code> options.</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">server</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token comment\"># The public facing domain name used to access grafana from a browser</span>\n<span class=\"token key attr-name\">domain</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">rizky.lab</span>\n\n<span class=\"token comment\"># The full public facing url you use in browser, used for redirects and emails</span>\n<span class=\"token comment\"># If you use reverse proxy and sub path specify full url (with sub path)</span>\n<span class=\"token comment\"># ;root_url = %(protocol)s://%(domain)s:%(http_port)s/</span>\n<span class=\"token key attr-name\">root_url</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">%(protocol)s://%(domain)s:%(http_port)s/grafana/</span>\n\n<span class=\"token comment\"># Serve Grafana from subpath specified in `root_url` setting. By default it is set to `false` for compatibility reasons.</span>\n<span class=\"token key attr-name\">serve_from_sub_path</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">true</span>\n</code></pre></div>\n<p>after setting this up, restart Grafana to pick up with the latest changes.</p>\n<p>now as the last step configure the Nginx as the reverse proxy to access our all mighty Grafana dashboard.</p>\n<p>here I previously configured a site as <code class=\"language-text\">rizky.lab</code> , so I am editing that to suit the needs, but you can try any way you like.</p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n  listen 80 default_server;\n  listen [::]:80 default_server;\n\n  root /var/www/rizky.lab;\n\n  index index.html;\n\n  server_name rizky.lab;\n\n         location /prometheus/ {\n                proxy_pass http://localhost:9090/;\n        }\n\n\n        location /grafana/ {\n                proxy_pass http://localhost:3000/;\n        }\n\n        location / {\n\n                try_files $uri $uri/ =404;\n        }\n\n        # Proxy Grafana Live WebSocket connections.\n        location /grafana/api/live {\n                proxy_http_version 1.1;\n                proxy_set_header Upgrade $http_upgrade;\n                proxy_set_header Connection &quot;Upgrade&quot;;\n                proxy_set_header Host $http_host;\n                proxy_pass http://localhost:3000/;\n        }\n\n}\n</code></pre></div>\n<p>and after all that, we can access the all mighty Grafana Dashboard, and configure it as you wish.</p>\n<hr>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 920px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/e925b024a658cb6c3367aebf70ffce61/29114/grafanadashbaord.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50.43478260869565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvUlEQVR42n1SybKbMBDkD2KeeYAQaEEbiw22Y/uSa56z+Gfy/5fOSCSVV6lUDl2jafVIMy1lolOomELdKLyWHHnBUJQt9q+c0GCf8gZFXCcwlFUHRvqaiRQLiqXskbMOGes0lOlhnYU0BsfDgO+PO749rnh+ueH5uOHr2w1CGzRSgwkFFRzsOqKfPcTssIYBP+6f8JwXZJ12GKcJl/MJy3LE+bTgelmxrgtOhMjP04hW9TDzCB0CDOVmGuAPM1pq5O4HvJkZn81EByqLspFp7Irar7iCsAG8t2iNQ+dciqyNI0ZrSFsLxDodRnSka6wB8xaFkDQyCaU34Fqj5iS0PfxlRLhMCB8nDNcZ/kyFZIdwJo0cYY4h7fukmzHeDmSFRVY1dEhvoHyApta1C+jIL9ZJ8kyBR9/o4QR14qYZyvmkb5VGI/RWa33S1a1AVnO5jUOxFVFokpCJKIh8tEKCi56K4kU66SvS/+H7jaM8dSjII2l8iqJ3qbChwopvXkVO0OO1xMc8Xh4vlb/0kRfKJX+zmrV42dfpv71H5P7F/28vcpmQEh92JfKXilBil/9eb9jlVeLeI+3lG/7mfwJgYRD4j0fXfQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Grafana Dashboard\" title=\"\" src=\"/static/e925b024a658cb6c3367aebf70ffce61/c0255/grafanadashbaord.png\" srcset=\"/static/e925b024a658cb6c3367aebf70ffce61/81c8e/grafanadashbaord.png 230w,\n/static/e925b024a658cb6c3367aebf70ffce61/08a84/grafanadashbaord.png 460w,\n/static/e925b024a658cb6c3367aebf70ffce61/c0255/grafanadashbaord.png 920w,\n/static/e925b024a658cb6c3367aebf70ffce61/b1001/grafanadashbaord.png 1380w,\n/static/e925b024a658cb6c3367aebf70ffce61/161ec/grafanadashbaord.png 1840w,\n/static/e925b024a658cb6c3367aebf70ffce61/29114/grafanadashbaord.png 1920w\" sizes=\"(max-width: 920px) 100vw, 920px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<hr>\n<h3>And with that I am over and out âœŒ</h3>\n<h3>If you got any problemo shoot me in the comments sections ðŸ”«</h3>\n<h3>Cheers ðŸ¥‚</h3>","frontmatter":{"title":"Setup Prometheus and Grafana on Orange Pi","date":"August 05, 2021","description":"Setup Prometheus and Grafana on Orange Pi For Monitoring Orange Pi Hardware Statistics","ogimage":"setup-prometheus-and-grafana-on-orange-pi.png"}},"previous":{"fields":{"slug":"/post/mistakes-i-made-deploying-Lambda-function/"},"frontmatter":{"title":"Mistakes i made deploying Lambda function"}},"next":{"fields":{"slug":"/post/updateing-blog/updating-blog/"},"frontmatter":{"title":"Updating Blog"}}},"pageContext":{"id":"1e1ede0c-1fb4-573b-805f-6664b223c8a8","previousPostId":"9a07a1d1-df4e-5db8-9179-20caab1aba8f","nextPostId":"f1296ea1-759b-5292-9a47-053553e28d11"}},"staticQueryHashes":["2841359383"],"slicesMap":{}}